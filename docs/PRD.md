# GMX v2 做市策略机器人 - 产品需求文档

## 1. 产品概述

### 1.1 产品定位
GMX v2 做市策略机器人是一个自动化的流动性管理工具，帮助用户在 GMX v2 协议上进行智能化的 LP（流动性提供者）做市，通过自动化策略最大化收益并控制风险。

### 1.2 目标用户
- 持有 ETH/USDC/BTC 等资产的 DeFi 用户
- 希望获得稳定收益但缺乏时间盯盘的投资者
- 对 GMX 生态有一定了解的进阶用户

### 1.3 核心价值
1. **自动化收益**: 无需手动操作，机器人自动寻找最优池子并调仓
2. **风险控制**: 内置风控机制，避免极端行情下的大额损失
3. **智能优化**: 基于数据分析，动态调整策略参数

---

## 2. GMX v2 机制分析

### 2.1 GM Pools（核心）
- 每个 GM Pool 由 4 种代币组成：Index Token、Long Token、Short Token、GM Token
- LP 获得 **63%** 的交易费用（杠杆交易、清算、借贷费、兑换）
- 费用自动复利，体现在 GM Token 价格上涨

### 2.2 GLV Pools（自动优化）
- 自动在多个 GM Pools 之间分配流动性
- 根据利用率自动调仓，优化资本效率
- 适合懒人策略

### 2.3 收益来源
| 来源 | 说明 |
|------|------|
| 交易费 | 63% 分给 LP |
| 借贷费 | 持仓者支付的借贷利息 |
| 清算费 | 清算时产生的费用 |
| 交易者亏损 | 历史数据显示交易者整体亏损 |

### 2.4 风险因素
| 风险 | 说明 | 缓解措施 |
|------|------|----------|
| 对手方风险 | 交易者盈利 = LP亏损 | 资金费率机制平衡多空 |
| 价格波动 | 标的资产价格变化 | Delta 对冲策略 |
| 智能合约风险 | 合约漏洞 | 多池分散 |

---

## 3. 功能需求

### 3.1 Phase 1: 数据监控层（MVP）

#### 3.1.1 池子数据获取
```
- 所有 GM/GLV 池列表
- 实时 APY/APR
- 池子 TVL 和利用率
- 当前多空比例（OI 分布）
- 借贷费率
```

#### 3.1.2 仪表盘展示
```
- 各池收益率排名
- 风险评分（基于多空平衡、波动率）
- 历史收益曲线
- 当前持仓状态
```

#### 3.1.3 告警系统
```
- APY 大幅变化告警
- 多空失衡告警
- 资产价格剧烈波动告警
```

### 3.2 Phase 2: 策略执行层

#### 3.2.1 基础策略
```python
# 策略1: 高APY追踪
- 自动识别 APY 最高的池子
- 在达到阈值时自动进入/退出

# 策略2: 低风险稳健
- 优先选择多空平衡的池子
- 避免极端波动的标的（如 MEME 币）
- 分散到多个池子

# 策略3: 智能轮动
- 监控池子利用率变化
- 在利用率低时退出，高时进入
- 捕捉费用高峰
```

#### 3.2.2 仓位管理
```
- 单池最大仓位限制
- 总仓位上限
- 自动再平衡
- 紧急退出机制
```

### 3.3 Phase 3: 高级功能

#### 3.3.1 Delta 对冲
```
- 计算当前 Delta 敞口
- 在 CEX 或其他 DEX 开对冲仓位
- 动态调整对冲比例
```

#### 3.3.2 多链支持
```
- Arbitrum（主）
- Avalanche
```

#### 3.3.3 回测系统
```
- 历史数据回测
- 策略参数优化
- 风险指标分析
```

---

## 4. 技术架构

### 4.1 技术栈选择
```yaml
语言: Python 3.10+
SDK: gmx_python_sdk
区块链交互: web3.py 6.10.0
数据库: SQLite (本地) / PostgreSQL (生产)
调度: APScheduler
监控: Prometheus + Grafana (可选)
通知: Telegram Bot / Discord Webhook
```

### 4.2 系统架构
```
┌─────────────────────────────────────────────────────┐
│                    用户界面层                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  │
│  │   CLI    │  │ Telegram │  │   Web Dashboard  │  │
│  └──────────┘  └──────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────┘
                        │
┌─────────────────────────────────────────────────────┐
│                    策略引擎层                        │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │
│  │ 策略管理器   │  │  风控模块    │  │ 仓位管理  │ │
│  └──────────────┘  └──────────────┘  └───────────┘ │
└─────────────────────────────────────────────────────┘
                        │
┌─────────────────────────────────────────────────────┐
│                    数据服务层                        │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │
│  │ 池子数据获取 │  │  价格服务    │  │ 历史数据  │ │
│  └──────────────┘  └──────────────┘  └───────────┘ │
└─────────────────────────────────────────────────────┘
                        │
┌─────────────────────────────────────────────────────┐
│                    区块链交互层                      │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │
│  │ GMX SDK      │  │  Web3.py     │  │ 多链支持  │ │
│  └──────────────┘  └──────────────┘  └───────────┘ │
└─────────────────────────────────────────────────────┘
```

### 4.3 核心模块

#### 模块1: DataFetcher
```python
class DataFetcher:
    """获取 GMX 数据"""
    - get_all_markets()      # 获取所有市场
    - get_pool_stats()       # 获取池子统计
    - get_apy()              # 获取 APY
    - get_open_interest()    # 获取持仓量
    - get_funding_rate()     # 获取资金费率
```

#### 模块2: StrategyEngine
```python
class StrategyEngine:
    """策略执行引擎"""
    - evaluate_pools()       # 评估池子得分
    - generate_signals()     # 生成交易信号
    - execute_rebalance()    # 执行再平衡
```

#### 模块3: RiskManager
```python
class RiskManager:
    """风险管理"""
    - check_position_limits()    # 检查仓位限制
    - calculate_drawdown()       # 计算回撤
    - emergency_exit()           # 紧急退出
```

#### 模块4: Executor
```python
class Executor:
    """交易执行器"""
    - deposit_to_pool()      # 存入池子
    - withdraw_from_pool()   # 从池子取出
    - claim_rewards()        # 领取奖励
```

---

## 5. 配置参数

### 5.1 策略参数
```yaml
strategy:
  type: "balanced"  # high_yield / balanced / conservative
  min_apy: 10.0     # 最低 APY 阈值 (%)
  max_single_pool: 30.0  # 单池最大占比 (%)
  rebalance_threshold: 5.0  # 触发再平衡的偏差 (%)

risk:
  max_drawdown: 10.0  # 最大回撤 (%)
  stop_loss: 15.0     # 止损线 (%)
  position_limit: 10000  # 总仓位上限 (USDC)

pools:
  whitelist:
    - "ETH-USDC"
    - "BTC-USDC"
    - "ARB-USDC"
  blacklist:
    - "DOGE-USDC"  # 避免高波动
```

### 5.2 运行参数
```yaml
execution:
  check_interval: 300  # 检查间隔 (秒)
  gas_price_limit: 50  # Gas 上限 (gwei)
  slippage: 0.5        # 滑点容忍度 (%)

notifications:
  telegram_enabled: true
  telegram_chat_id: "xxx"
  alert_on_trade: true
  daily_report: true
```

---

## 6. 开发路线图

### Phase 1: 数据层 + CLI（2-3周）
- [ ] 项目骨架搭建
- [ ] 集成 gmx_python_sdk
- [ ] 实现数据获取模块
- [ ] CLI 工具 - 查看池子状态
- [ ] 基础告警功能

### Phase 2: 策略层（2-3周）
- [ ] 策略引擎框架
- [ ] 实现 3 种基础策略
- [ ] 仓位管理逻辑
- [ ] 风控模块
- [ ] 自动执行调度

### Phase 3: 优化完善（2-3周）
- [ ] 历史数据记录
- [ ] 回测框架
- [ ] Telegram Bot 通知
- [ ] Web Dashboard（可选）
- [ ] 多链支持

---

## 7. 风险提示

1. **智能合约风险**: GMX 合约可能存在漏洞
2. **市场风险**: 极端行情下可能产生亏损
3. **技术风险**: 机器人bug可能导致错误操作
4. **监管风险**: DeFi 法规不确定性

**重要**: 本工具仅供学习和研究使用，请勿投入超过承受能力的资金。

---

## 8. 参考资料

- [GMX v2 官方文档](https://docs.gmx.io/docs/providing-liquidity/v2/)
- [GMX Python SDK](https://github.com/snipermonke01/gmx_python_sdk)
- [GMX 合约](https://github.com/gmx-io/gmx-contracts)
- [GMX 2025 开发计划](https://gmxio.substack.com/p/gmx-development-plan-for-2025)
